# SPDX-License-Identifier: GPL-2.0
# Copyright (C) 2017-present Team LibreELEC (https://libreelec.tv)

PKG_RKBIN="$(get_build_dir rkbin)"
PKG_SOC="px30"

PKG_BOOT_INI="${PKG_RKBIN}"/RKBOOT/"${DEVICE}"MINIALL.ini
PKG_DATAFILE="${PKG_RKBIN}"/$(sed -n "/FlashData/s/FlashData=//p" "${PKG_BOOT_INI}")
PKG_LOADER="${PKG_RKBIN}"/$(sed -n "/FlashBoot/s/FlashBoot=//p" "${PKG_BOOT_INI}")
PKG_LOAD_ADDR="0x00200000"

# idbloader.img
if [ -n "${PKG_DATAFILE}" -a -n "${PKG_LOADER}" ]; then
  "${PKG_RKBIN}/tools/mkimage" -n "${PKG_SOC}" -T rksd -d "${PKG_DATAFILE}" -C bzip2 idbloader.img || exit 1
  cat "${PKG_LOADER}" >> idbloader.img
  cp -av idbloader.img "${INSTALL}/usr/share/bootloader"
fi

# uboot.img
if [ -n "${PKG_LOAD_ADDR}" ]; then
#  DTB="$(${BUILD_ROOT}/${SCRIPTS}/uboot_helper ${PROJECT} ${DEVICE} ${UBOOT_SYSTEM} dtb)"
#  cat u-boot-nodtb.bin "${BUILD}/image/system/usr/share/bootloader/${DTB}" > u-boot-dtb.bin
#  "${PKG_RKBIN}/tools/loaderimage" --pack --uboot u-boot-nodtb.bin uboot.img "$PKG_LOAD_ADDR}" || exit 1
  "${PKG_RKBIN}/tools/loaderimage" --pack --uboot u-boot-dtb.bin uboot.img "$PKG_LOAD_ADDR}" || exit 1
  cp -av uboot.img "${INSTALL}/usr/share/bootloader"
#  cp -av ~/ROCKNIX_uboot.img "${INSTALL}/usr/share/bootloader/uboot.img"
fi

# trust.img
PKG_ATF_INI="${PKG_RKBIN}/RKTRUST/${DEVICE}TRUST.ini"
if [ -n "${PKG_ATF_INI}" ]; then
  if [ ! -f "${PKG_ATF_INI}.org" ]; then
    cp -av "${PKG_ATF_INI}" "${PKG_ATF_INI}.org"
  fi
  sed -e 's|ADDR=0x00040000|ADDR=0x00010000|' \
      -i "${PKG_ATF_INI}"
  "${PKG_RKBIN}/tools/trust_merger" --ignore-bl32 --verbose --prepath "${PKG_RKBIN}/" "${PKG_ATF_INI}" || exit 1
  cp -av trust.img "${INSTALL}/usr/share/bootloader"
fi

# Install boot.ini if it exists
if find_file_path "bootloader/boot.ini"; then
  cp -av "${FOUND_PATH}" "${INSTALL}/usr/share/bootloader/boot.ini"
fi
